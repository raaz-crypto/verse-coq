#+TITLE: Explicit formula for curve25519 computation.

The curve C : y¬≤ = x¬≥ + A x¬≤ + x over the finite field ùîΩ‚Çö. In our
case the prime p = 2¬≤‚Åµ‚Åµ - 19 and the constant A is 486662.


* X25519 Diffie-Hellman.


The curve is such that if P = (x,y) ‚àà E(C) then -P = (x, -y) ‚àà
E(C). Since we use only the x-coordinate, we do not need to
distinguish the points P and -P.


Therefore the rule is given points P and Q find and R such that R ‚àà
Line(P,Q) ‚à© E(C). Let y = m x + c be the line through P and Q. We have
m = (y‚ÇÅ - y‚ÇÇ)/(x‚ÇÅ - x‚ÇÇ). Substituting in C and realising that
x(P+Q) + x(P) + x(Q) should be the negative of the x¬≤-coefficient we have.


- x(P+Q) = m¬≤ - A - x(P) - x(Q).

For doubling the associated formula is

- x(2P) = m¬≤ - A - 2 x(P)  where m is now the slope of the tangent = (3x¬≤ + 2A x + 1)/(2 y).

** Montgomery ladder.

Given a base point B on the curve and a number n = a‚ÇÄ + a‚ÇÅ 2 + ... +
a‚Çñ 2·µè we want to compute the n B; rather we want to compute the
x-coordinate of n B. We compute a sequence of point pairs.

P·µ¢ , Q·µ¢ such that P·µ¢ = n·µ¢ B and Q·µ¢ = (n·µ¢ + 1) B. The n·µ¢'s are choosen
with the property that n·µ¢ = ‚åà n/2·µè‚Åª‚Å± ‚åâ = a‚Çñ‚Çã·µ¢ + 2 * a‚Çñ‚Çã·µ¢‚Çä‚ÇÅ + ... + 2‚Å±
a‚Çñ.  To start the process, we can set P‚Çã‚ÇÅ = n‚Çã‚ÇÅ B = 0 B = ‚àû ; Q‚Çã‚ÇÅ = B.
When i = k we have the desired result.

Consider the stage (i - 1) and let P = P·µ¢‚Çã‚ÇÅ and Q = Q·µ¢‚Çã‚ÇÅ. We have the following cases.

- a‚Çñ‚Çã·µ¢ = 0 ::

  We have n·µ¢ = 2  and hence P·µ¢ = 2P and Q·µ¢ = P + Q.

- a‚Çñ‚Çã·µ¢ = 1 :: Then P·µ¢ = P + Q and Q·µ¢ = 2Q.


Define a /Montgomery step/ as computing (2 P, P+Q) from (P, Q).  Notice
that depending on whether the bit a‚Çñ‚Çã·µ¢ we might have to compute either
(2P , P + Q) or (2Q, P+Q). In the most complete sense, Montgomery step
is the following.


- Montegomery step :: Given (P,Q) and the point B such that Q - P = B,
  compute (2 P, P+Q). We will denote this by the function Montgomery :
  E * E -> E * E.

*** Swapping and climbing the ladder.

In our case, we need all the P·µ¢'s and Q·µ¢'s and it is sufficient to
iterate the Montegomery step with appropriate swaps. Notice that
(P·µ¢,Q·µ¢) = swap a‚Çñ‚Çã·µ¢ . Montgomery . swap a‚Çñ‚Çã·µ¢ (P,Q)

swap b (P,Q) = if b = 0 then (P,Q) else (Q,P).


Notice that we have B = Q - P. If we swap we need the point -B = P -
Q, which, fortunately has the same x-coordinate of B which is all what
we care about during the computation.


** In projective coordinates.

The main idea is to rewrite the formulae for x-cordinates purely in
terms of x-coordinates and then homogenize using x = X/Z.

*** Doubling the point P.

x(2P) = (3x¬≤ + 2A x + 1)¬≤/4y¬≤ - A - 2 x(P).
      = function in x alone  (by replacing y¬≤ with x¬≥ + A x¬≤ + x)
      =

- X(2P) = (X¬≤ - Z¬≤)¬≤
- Z(2P) = 4XZ(X¬≤ + A X Z + Z¬≤)

*** Point addition P + Q

We assume that we have the points P and Q with coordinates [x‚ÇÅ,z‚ÇÅ] and
[x‚ÇÇ,z‚ÇÇ] respectively and we know the x-coordinate of x‚ÇÄ of the point B
= Q - P.

The formula for point addition is given by.

x = [(x‚ÇÅ + x‚ÇÇ)(1 + x‚ÇÅ x‚ÇÇ) + 2 A x‚ÇÅ x‚ÇÇ - 2 y‚ÇÅ y‚ÇÇ]/ (x‚ÇÇ - x‚ÇÅ)¬≤


Using this we get

x(B) = [(x‚ÇÅ + x‚ÇÇ)(1 + x‚ÇÅ x‚ÇÇ) + 2 A x‚ÇÅ x‚ÇÇ + 2 y‚ÇÅ y‚ÇÇ]/ (x‚ÇÇ - x‚ÇÅ)¬≤


Which gives 2y‚ÇÅy‚ÇÇ = x(B) (x‚ÇÇ - x‚ÇÅ)¬≤ - (x‚ÇÅ + x‚ÇÇ)(1 + x‚ÇÅ x‚ÇÇ) - 2 A x‚ÇÅ
x‚ÇÇ. We then substitute 2y‚ÇÅy‚ÇÇ to get a x-only formulae which we can
homogenize. This results in the following projective equation for the
X and Z coordinates of P + Q.



- X  =  (X‚ÇÅ X‚ÇÇ  - Z‚ÇÅ Z‚ÇÇ)¬≤

- Z  =  X(B) (X‚ÇÅ Z‚ÇÇ  - X‚ÇÇ Z‚ÇÅ )¬≤


** Optimised formula

We need to compute the following homogeneous coordinates at the end of
each montgomery step.


- X‚ÇÇ·µ¢    = (X·µ¢¬≤ - Z·µ¢¬≤)¬≤
- Z‚ÇÇ·µ¢    = 4X·µ¢Z·µ¢(X·µ¢¬≤ + A X·µ¢ Z·µ¢ + Z·µ¢¬≤)
- X‚ÇÇ·µ¢‚Çä‚ÇÅ  =  (X·µ¢ X·µ¢‚Çä‚ÇÅ  - Z·µ¢ Z·µ¢‚Çä‚ÇÅ)¬≤
- Z‚ÇÇ·µ¢‚Çä‚ÇÅ  =  X(B) (X·µ¢ Z·µ¢‚Çä‚ÇÅ  - X·µ¢‚Çä‚ÇÅ Z·µ¢ )¬≤

  Based on https://martin.kleppmann.com/papers/curve25519.pdf (which
  it self is an explanation of tweet NaCl implementation) we give the
  following optimised implementation as a table. The actual code is
  different in that we disallow assignments of the kind a *= b.

We start with t‚ÇÄ, t‚ÇÅ, t‚ÇÇ, t‚ÇÉ having the value X·µ¢ = a, X·µ¢‚Çä‚ÇÅ = b, Z·µ¢ = c
and Z·µ¢‚Çä‚ÇÅ = d respectively.

To see the correctness of the algorithm, look on to the SSA form of
the program. The Value column gives the value of the appropriate SSA
variable in terms of the original value a,b,c, and d.

Based on the SSA program, we compute the lifetime. An SSA variable v·µ¢
has a lifetime of ~l~ if the last SSA assignment where it is used is
~v‚Çó~. An infinity (‚àû) in the life time column indicate that the value
is required in the next Montgomery step.

Based on the lifetimes, we compute a register allocation into
registers 6 registers t‚ÇÄ...t‚ÇÖ. The actual series of assignment is
given in the right most column. The property that we should ensure is
that if t is the register allocated for an SSA variable v·µ¢ then it
should not be reallocated before the life time of v·µ¢ expires.


| Lifetime | SSA              | Value                         | Register allocation | Assignment       |
|----------+------------------+-------------------------------+---------------------+------------------|
|        2 | t‚ÇÄ = a           | a                             | t‚ÇÄ                  | NOP              |
|        4 | t‚ÇÅ = b           | b                             | t‚ÇÅ                  | NOP              |
|        2 | t‚ÇÇ = c           | c                             | t‚ÇÇ                  | NOP              |
|        4 | t‚ÇÉ = d           | d                             | t‚ÇÉ                  | NOP              |
|----------+------------------+-------------------------------+---------------------+------------------|
|        6 | v‚ÇÅ = t‚ÇÄ + t‚ÇÇ     | a + c                         | t‚ÇÑ                  | t‚ÇÑ  = t‚ÇÄ + t‚ÇÇ    |
|        8 | v‚ÇÇ = t‚ÇÄ - t‚ÇÇ     | a - c                         | t‚ÇÄ                  | t‚ÇÄ -= t‚ÇÇ         |
|        7 | v‚ÇÉ = t‚ÇÅ + t‚ÇÉ     | b + d                         | t‚ÇÖ                  | t‚ÇÖ = t‚ÇÅ + t‚ÇÉ     |
|        5 | v‚ÇÑ = t‚ÇÅ - t‚ÇÉ     | b - d                         | t‚ÇÅ                  | t‚ÇÅ -= t‚ÇÉ         |
|----------+------------------+-------------------------------+---------------------+------------------|
|       10 | v‚ÇÖ = v‚ÇÅ * v‚ÇÑ     | (a + c)(b - d)                | t‚ÇÇ                  | t‚ÇÇ = t‚ÇÑ * t‚ÇÅ     |
|       15 | v‚ÇÜ = v‚ÇÅ ¬≤        | (a + c)¬≤                      | t‚ÇÅ                  | t‚ÇÅ = t‚ÇÑ¬≤         |
|       10 | v‚Çá = v‚ÇÇ * v‚ÇÉ     | (a - c)(b + d)                | t‚ÇÉ                  | t‚ÇÉ = t‚ÇÄ t‚ÇÖ       |
|       13 | v‚Çà = v‚ÇÇ ¬≤        | (a - c)¬≤                      | t‚ÇÑ                  | t‚ÇÑ = t‚ÇÄ¬≤         |
|----------+------------------+-------------------------------+---------------------+------------------|
|       18 | v‚Çâ  = v‚ÇÖ + v‚Çá    | 2(ab - cd)                    | t‚ÇÖ                  | t‚ÇÖ = t‚ÇÇ + t‚ÇÉ     |
|       11 | v‚ÇÅ‚ÇÄ = v‚ÇÖ - v‚Çá    | 2(ad - bc)                    | t‚ÇÇ                  | t‚ÇÇ -= t‚ÇÉ         |
|       17 | v‚ÇÅ‚ÇÅ = v‚ÇÅ‚ÇÄ ¬≤      | 4(ad - bc)¬≤                   | t‚ÇÄ                  | t‚ÇÄ  = t‚ÇÇ¬≤        |
|       ‚àû  | v‚ÇÅ‚ÇÇ = v‚ÇÜ * v‚Çà    | (a¬≤ - c¬≤)¬≤           = X‚ÇÇ·µ¢    | t‚ÇÇ                  | t‚ÇÇ = t‚ÇÅ * t‚ÇÑ     |
|       16 | v‚ÇÅ‚ÇÉ = v‚ÇÜ - v‚Çà    | 4ac                           | t‚ÇÉ                  | t‚ÇÉ = t‚ÇÅ - t‚ÇÑ     |
|       15 | v‚ÇÅ‚ÇÑ = 121665 v‚ÇÅ‚ÇÉ | 486660 ac = (A - 2)a c        | t‚ÇÑ                  | t‚ÇÑ = 121665 * t‚ÇÉ |
|       16 | v‚ÇÅ‚ÇÖ = v‚ÇÜ + v‚ÇÅ‚ÇÑ   | a¬≤ + A ac + c¬≤                | t‚ÇÅ                  | t‚ÇÅ += t‚ÇÑ         |
|       ‚àû  | v‚ÇÅ‚ÇÜ = v‚ÇÅ‚ÇÉ * v‚ÇÅ‚ÇÖ  | 4ac (a¬≤ + A ac + c¬≤) = Z‚ÇÇ·µ¢    | t‚ÇÑ                  | t‚ÇÑ = t‚ÇÉ * t‚ÇÅ     |
|       ‚àû  | v‚ÇÅ‚Çá = v‚ÇÅ‚ÇÅ X      | 4 X(ad - b c)¬≤       = 4Z‚ÇÇ·µ¢‚Çä‚ÇÅ | t‚ÇÅ                  | t‚ÇÅ = t‚ÇÄ * X      |
|       ‚àû  | v‚ÇÅ‚Çà = v‚Çâ ¬≤       | 4 (ab - cd)¬≤         = 4X‚ÇÇ·µ¢‚Çä‚ÇÅ | t‚ÇÉ                  | t‚ÇÉ = t‚ÇÖ¬≤         |
|----------+------------------+-------------------------------+---------------------+------------------|

At the end of the computation we should have [X‚ÇÇ·µ¢ : Z‚ÇÇ·µ¢] and [X‚ÇÇ·µ¢‚Çä‚ÇÅ :
Z‚ÇÇ·µ¢‚Çä‚ÇÅ] which are available in the registers [t‚ÇÇ : t‚ÇÑ] and [t‚ÇÉ : t‚ÇÅ]
respectively. Therefore the Montgomery step should be repeated with
t‚ÇÇ, t‚ÇÉ, t‚ÇÑ and t‚ÇÅ.


The monocypher library which inturn borrows from the supercop
implementation has the following operations.

#+begin_src C
  // Montgomery ladder step: replaces (P2, P3) by (P2*2, P2+P3)
  // with differential addition
  fe_sub(t0, x3, z3);  fe_sub(t1, x2, z2);    fe_add(x2, x2, z2);
  fe_add(z2, x3, z3);  fe_mul(z3, t0, x2);    fe_mul(z2, z2, t1);
  fe_sq (t0, t1    );  fe_sq (t1, x2    );    fe_add(x3, z3, z2);
  fe_sub(z2, z3, z2);  fe_mul(x2, t1, t0);    fe_sub(t1, t1, t0);
  fe_sq (z2, z2    );  fe_mul121666(z3, t1);  fe_sq (x3, x3    );
  fe_add(t0, t0, z3);  fe_mul(z3, x1, z2);    fe_mul(z2, t1, t0);
#+end_src

Here give the instructions in tabular form.



| SSA                | Value                    | Register allocation | Assignment        |
|--------------------+--------------------------+---------------------+-------------------|
| a                  | a  (x‚ÇÇ)                  | x‚ÇÇ                  | NOP               |
| b                  | b  (x‚ÇÉ)                  | x‚ÇÉ                  | NOP               |
| c                  | c  (z‚ÇÇ)                  | z‚ÇÇ                  | NOP               |
| d                  | d  (z‚ÇÉ)                  | z‚ÇÉ                  | NOP               |
|--------------------+--------------------------+---------------------+-------------------|
| v‚ÇÅ = x‚ÇÉ - z‚ÇÉ       | b - d                    | t‚ÇÄ                  | t‚ÇÄ  = x‚ÇÉ - z‚ÇÉ     |
| v‚ÇÇ = x‚ÇÇ - z‚ÇÇ       | a - c                    | t‚ÇÅ                  | t‚ÇÅ  = x‚ÇÇ - z‚ÇÇ     |
| v‚ÇÉ = x‚ÇÇ + z‚ÇÇ       | a + c                    | x‚ÇÇ                  | x‚ÇÇ += z‚ÇÇ          |
|--------------------+--------------------------+---------------------+-------------------|
| v‚ÇÑ = x‚ÇÉ + z‚ÇÉ       | b + d                    | z‚ÇÇ                  | z‚ÇÇ = x‚ÇÉ + z‚ÇÉ      |
| v‚ÇÖ = v‚ÇÅ * v‚ÇÉ       | (b - d)(a + c)           | z‚ÇÉ                  | z‚ÇÉ = t‚ÇÄ * x‚ÇÇ      |
| v‚ÇÜ = v‚ÇÑ * v‚ÇÇ       | (b + d)(a - c)           | z‚ÇÇ                  | z‚ÇÇ *= t‚ÇÅ          |
|--------------------+--------------------------+---------------------+-------------------|
| v‚Çá = v‚ÇÇ¬≤           | (a - c)¬≤                 | t‚ÇÄ                  | t‚ÇÄ := t‚ÇÅ¬≤         |
| v‚Çà = v‚ÇÉ¬≤           | (a + c)¬≤                 | t‚ÇÅ                  | t‚ÇÅ := x‚ÇÇ¬≤         |
| v‚Çâ = v‚ÇÖ + v‚ÇÜ       | 2(ab - cd)               | x‚ÇÉ                  | x‚ÇÉ := z‚ÇÉ + z‚ÇÇ     |
|--------------------+--------------------------+---------------------+-------------------|
| v‚ÇÅ‚ÇÄ = v‚ÇÖ - v‚ÇÜ      | 2(bc - ad)               | z‚ÇÇ                  | z‚ÇÇ := z‚ÇÉ - z‚ÇÇ     |
| v‚ÇÅ‚ÇÅ = v‚Çá * v‚Çà      | (a¬≤ - c¬≤)¬≤               | x‚ÇÇ                  | x‚ÇÇ := t‚ÇÅ * t‚ÇÄ     |
| v‚ÇÅ‚ÇÇ = v‚Çà - v‚Çá      | 4 ac                     | t‚ÇÅ                  | t‚ÇÅ -= t‚ÇÄ          |
|--------------------+--------------------------+---------------------+-------------------|
| v‚ÇÅ‚ÇÉ = v‚ÇÅ‚ÇÄ¬≤         | 4(bc - ad)¬≤              | z‚ÇÇ                  | z‚ÇÇ := z‚ÇÇ¬≤         |
| v‚ÇÅ‚ÇÑ = 121666 * v‚ÇÅ‚ÇÇ | 486664 ac                | z‚ÇÉ                  | z‚ÇÉ := 121666 * t‚ÇÅ |
| v‚ÇÅ‚ÇÖ = v‚Çâ¬≤          | 4(ab - cd)¬≤              | x‚ÇÉ                  | x‚ÇÉ := x‚ÇÉ¬≤         |
|--------------------+--------------------------+---------------------+-------------------|
| v‚ÇÅ‚ÇÜ = v‚Çá + v‚ÇÅ‚ÇÑ     | a¬≤ + c¬≤ + 486662 ac      | t‚ÇÄ                  | t‚ÇÄ += z‚ÇÉ          |
| v‚ÇÅ‚Çá = x‚ÇÅ * z‚ÇÇ      | 4 X(B)(bc - ad)¬≤         | z‚ÇÉ                  | z‚ÇÉ := x‚ÇÅ * z‚ÇÇ     |
| v‚ÇÅ‚Çà = v‚ÇÅ‚ÇÇ * v‚ÇÅ‚ÇÜ    | 4ac(a¬≤ + c¬≤ + 486662 ac) | z‚ÇÇ                  | z‚ÇÇ := t‚ÇÅ * t‚ÇÄ     |
|--------------------+--------------------------+---------------------+-------------------|


We start with x‚ÇÅ = X(B) the base point (z‚ÇÅ = 1) and the values [a : c] = [X(P) : Z(P)]
[b : d] = [X(Q) : Z(Q)].
The result is that we have X and Z coordinates as follows.



| Coordinate | Value               | SSA Variable | Program Variable |
|------------+---------------------+--------------+------------------|
| X(2P)      | (a¬≤ - c¬≤)¬≤          | v‚ÇÅ‚ÇÅ          | x‚ÇÇ               |
| Z(2P)      | 4ac(a¬≤ + 486662 ac) | v‚ÇÅ‚Çà          | z‚ÇÇ               |
| X(P+Q)     | 4(ab - cd)¬≤         | v‚ÇÅ‚ÇÖ          | x‚ÇÉ               |
| Z(P+Q)     | 4X(B)(bc - ad)¬≤     | v‚ÇÅ‚Çá          | z‚ÇÉ               |
